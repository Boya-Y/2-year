<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÊÅãÈõ™</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    body { margin: 0; padding: 0; background-color: #fdf6e3; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'ZCOOL KuaiLe', sans-serif; color: #555; }
    #game-container { position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; background: #fff; }
    canvas { display: block; cursor: default; }
    .fade-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
    .fade-active { opacity: 1; }
    #tooltip { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 14px; color: #aaa; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="gameCanvas" width="900" height="600"></canvas>
    <div id="fadeLayer" class="fade-overlay"></div>
    <div id="tooltip">ÊèêÁ§∫ÔºöÊ≠£Á°ÆÁöÑÈÄâÊã©ÂæÄÂæÄ‰∏çÂú®ÈÄâÈ°πÈáå</div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const fadeLayer = document.getElementById('fadeLayer');
    const tooltip = document.getElementById('tooltip');

    const STATE = { MENU: 0, SCENE_1_CHAT: 1, SCENE_1_PHONE: 2, SCENE_2_DINNER: 3, SCENE_3_WALK: 4, ENDING: 5 };
    const COLORS = { bg: '#fffaf0', primary: '#ff8da1', xhs_red: '#ff2442', text: '#5d5d5d', highlight: '#ffb7c5', ui_gray: '#e0e0e0', phone_screen: '#f8f8f8', bubble_green: '#95ec69' };

    let currentState = STATE.MENU;
    let score = 0; let frameCount = 0; let mouse = { x: 0, y: 0, clicked: false };
    let textTyper = { text: '', index: 0, complete: false };
    let billTimer = 0, walkTimer = 0, showDinnerOptions = false, waiterX = 600;
    let flags = { sawMoments: false, paidSecretly: false, gaveCoat: false, scene1Finished: false, scene2Finished: false, scene3Finished: false };

    function resetGame() { score = 0; frameCount = 0; billTimer = 0; walkTimer = 0; showDinnerOptions = false; waiterX = 600; flags = { sawMoments: false, paidSecretly: false, gaveCoat: false, scene1Finished: false, scene2Finished: false, scene3Finished: false }; resetTyper(); }
    function typeText(str, speed = 2) { if (textTyper.text !== str) { textTyper.text = str; textTyper.index = 0; textTyper.complete = false; } if (!textTyper.complete) { if (frameCount % speed === 0) textTyper.index++; if (textTyper.index >= str.length) textTyper.complete = true; } return str.substring(0, textTyper.index); }
    function resetTyper() { textTyper.text = ''; textTyper.index = 0; textTyper.complete = false; }
    function transitionTo(newState, callback) { fadeLayer.classList.add('fade-active'); setTimeout(() => { if (callback) callback(); currentState = newState; mouse.clicked = false; resetTyper(); fadeLayer.classList.remove('fade-active'); }, 1000); }
    const DESIGN_W = 900, DESIGN_H = 600;
    function resize() { const scale = Math.min(window.innerWidth / DESIGN_W, window.innerHeight / DESIGN_H); const dpr = window.devicePixelRatio || 1; canvas.style.width = (DESIGN_W * scale) + 'px'; canvas.style.height = (DESIGN_H * scale) + 'px'; canvas.width = DESIGN_W * dpr; canvas.height = DESIGN_H * dpr; ctx.setTransform(dpr, 0, 0, dpr, 0, 0); }
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', resize);

    function drawRect(x, y, w, h, color, radius = 0) { ctx.fillStyle = color; ctx.beginPath(); if (ctx.roundRect) ctx.roundRect(x, y, w, h, radius); else { ctx.moveTo(x + radius, y); ctx.arcTo(x + w, y, x + w, y + h, radius); ctx.arcTo(x + w, y + h, x, y + h, radius); ctx.arcTo(x, y + h, x, y, radius); ctx.arcTo(x, y, x + w, y, radius); } ctx.fill(); }
    function drawCircle(x, y, r, color) { ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill(); }
    function drawText(text, x, y, size, color = COLORS.text, align = 'center') { ctx.fillStyle = color; ctx.font = `${size}px "ZCOOL KuaiLe", sans-serif`; ctx.textAlign = align; ctx.fillText(text, x, y); }
    function isHover(x, y, w, h) { return mouse.x > x && mouse.x < x + w && mouse.y > y && mouse.y < y + h; }
    function drawButton(text, x, y, w, h, callback, btnColor = COLORS.primary) { const hover = isHover(x, y, w, h); if (hover) canvas.style.cursor = 'pointer'; ctx.fillStyle = hover ? btnColor : '#fff'; ctx.strokeStyle = btnColor; ctx.lineWidth = 3; ctx.beginPath(); if (ctx.roundRect) ctx.roundRect(x, y, w, h, 10); else drawRect(x, y, w, h, ctx.fillStyle, 10); ctx.fill(); ctx.stroke(); let fontSize = 18; if (text.length > 12) fontSize = 16; if (text.length > 16) fontSize = 14; if (text.length > 20) fontSize = 12; ctx.font = `${fontSize}px "ZCOOL KuaiLe", sans-serif`; ctx.textAlign = 'center'; ctx.fillStyle = hover ? '#fff' : btnColor; ctx.fillText(text, x + w/2, y + h/2 + fontSize/3); if (hover && mouse.clicked) { mouse.clicked = false; callback(); } }
    function drawBean(x, y, isGirl = false, emotion = 'normal') { ctx.save(); ctx.translate(x, y); ctx.fillStyle = '#fff'; ctx.strokeStyle = '#333'; ctx.lineWidth = 3; ctx.beginPath(); ctx.ellipse(0, 0, 40, 50, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); ctx.fillStyle = '#333'; if (emotion === 'happy') { ctx.beginPath(); ctx.moveTo(-15, -5); ctx.lineTo(-5, -15); ctx.lineTo(5, -5); ctx.moveTo(15, -5); ctx.lineTo(25, -15); ctx.lineTo(35, -5); ctx.stroke(); } else { drawCircle(-15, -10, 3, '#333'); drawCircle(15, -10, 3, '#333'); } if (isGirl || emotion === 'shy') { ctx.fillStyle = '#ffb7c5'; ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.arc(-20, 5, 6, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(20, 5, 6, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0; } if (isGirl) { ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, -10, 42, Math.PI, 0); ctx.fill(); ctx.beginPath(); ctx.arc(-40, 10, 10, 0, Math.PI * 2); ctx.fill(); } ctx.restore(); }

    function updateMenu() { ctx.fillStyle = COLORS.bg; ctx.fillRect(0, 0, 900, 600); drawText('ÊÅãÈõ™', 450, 250, 80, COLORS.primary); drawText('È´òÊ∏ÖÁâà', 450, 300, 24, '#aaa'); const scale = 1 + Math.sin(frameCount * 0.05) * 0.05; ctx.save(); ctx.translate(450, 150); ctx.scale(scale, scale); drawText('‚ù§', 0, 0, 60, COLORS.primary); ctx.restore(); drawButton('ÂºÄÂßãÊÅãÈõ™', 350, 400, 200, 60, () => { transitionTo(STATE.SCENE_1_CHAT, resetGame); }); }

    function updateScene1() {
      ctx.fillStyle = '#ddd'; ctx.fillRect(0, 0, 800, 600);
      const px = 250, py = 50, pw = 300, ph = 500;
      drawRect(px, py, pw, ph, '#333', 30);
      drawRect(px + 10, py + 10, pw - 20, ph - 20, COLORS.phone_screen, 20);
      drawRect(px + 10, py + 10, pw - 20, 50, '#fff', 20); ctx.fillRect(px + 10, py + 30, pw - 20, 30);
      drawText('Â∞èÁ∫¢‰π¶', px + 150, py + 45, 18, '#333');
      drawText('<', px + 30, py + 45, 20, '#333');
      drawText('...', px + 270, py + 40, 20, '#333');

      const avatarX = px + 20, avatarY = py + 70, avatarR = 20;
      drawCircle(avatarX + avatarR, avatarY + avatarR, avatarR, COLORS.xhs_red);
      drawText('Ê©òÁîü‚ú®', px + 90, avatarY + 25, 16, '#333', 'left');
      drawText('Âú®Ê†°', px + 90, avatarY + 45, 12, '#aaa', 'left');
      if (!flags.sawMoments) drawCircle(avatarX + 2 * avatarR, avatarY + 5, 5, 'red');
      if (isHover(avatarX, avatarY, 50, 50)) { canvas.style.cursor = 'pointer'; if (mouse.clicked) { mouse.clicked = false; currentState = STATE.SCENE_1_PHONE; } }

      let textY = py + 150;
      drawCircle(px + 40, textY + 10, 15, COLORS.xhs_red);
      drawRect(px + 65, textY - 5, 60, 36, '#fff', 5);
      drawText('dd', px + 95, textY + 20, 16, '#333');

      ctx.strokeStyle = '#eee'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(px + 10, py + 60); ctx.lineTo(px + pw - 10, py + 60); ctx.stroke();

      if (frameCount > 60) {
        const optY = py + 350; const btnColor = COLORS.xhs_red; const btnW = 280; const btnX = px + (pw - btnW) / 2;
        drawButton('‰Ω†ÁúüÁæé', btnX, optY, btnW, 40, () => { flags.scene1Finished = true; transitionTo(STATE.SCENE_2_DINNER); }, btnColor);
        drawButton('ÂÖàËÆ§ËØÜ‰Ω†ÔºåËØ∑ÈóÆ‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠ó', btnX, optY + 50, btnW, 40, () => { flags.scene1Finished = true; score += 0; transitionTo(STATE.SCENE_2_DINNER); }, btnColor);
        if (flags.sawMoments) { ctx.shadowBlur = 10; ctx.shadowColor = COLORS.xhs_red; drawButton('ÂÖàËÆ§ËØÜ‰Ω†Âπ∂ÁÇπËµûÔºåËØ¥Êòé‰Ω†‰∏ÄÂÆöÂæàÂ•ΩËÆ∞ÊÄß', btnX, optY - 50, btnW, 40, () => { score += 2; flags.scene1Finished = true; transitionTo(STATE.SCENE_2_DINNER); }, btnColor); ctx.shadowBlur = 0; }
      }
    }

    function updateScene1Phone() {
      ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0, 0, 800, 600);
      const px = 250, py = 50, pw = 300, ph = 500;
      drawRect(px, py, pw, ph, '#fff', 30);
      drawRect(px + 10, py + 10, pw - 20, 100, '#ccc', 20); ctx.fillRect(px + 10, py + 80, pw - 20, 30);
      drawCircle(px + 40, py + 110, 35, COLORS.xhs_red);
      drawText('Ê©òÁîü‚ú®', px + 120, py + 130, 18, '#333', 'left');
      drawText('Â∞èÁ∫¢‰π¶Âè∑Ôºö12345678', px + 120, py + 150, 12, '#aaa', 'left');
      drawRect(px + 220, py + 120, 60, 26, COLORS.xhs_red, 13); drawText('ÂÖ≥Ê≥®', px + 250, py + 138, 14, '#fff');

      const startY = py + 180; drawText('Á¨îËÆ∞', px + 50, startY, 16, '#333'); drawText('Êî∂Ëóè', px + 120, startY, 16, '#aaa'); drawText('ËµûËøá', px + 190, startY, 16, '#aaa');
      const picW = 120, picH = 140, gap = 20;
      drawRect(px + 20, startY + 20, picW, picH, '#f0f0f0', 5); ctx.fillStyle = COLORS.xhs_red; ctx.beginPath(); ctx.arc(px + 80, startY + 70, 20, 0, Math.PI * 2); ctx.fill(); drawText('Ëá™Êãç‰∏ÄÂº† ~', px + 80, startY + 140, 12, '#333'); drawText('‚ù§ 1.2w', px + 110, startY + 155, 10, '#aaa');
      drawRect(px + 20 + picW + gap, startY + 20, picW, picH, '#f0f0f0', 5); drawText('Êé¢Â∫ó ...', px + 20 + picW + gap + 60, startY + 140, 12, '#333');
      drawButton('ËøîÂõû‰∏ªÈ°µ', px + 50, py + 430, 200, 40, () => { flags.sawMoments = true; currentState = STATE.SCENE_1_CHAT; }, COLORS.xhs_red);
    }

    function updateScene2() {
      if (mouse.clicked && !flags.scene2Finished && !showDinnerOptions) {
        if (isHover(500, 100, 200, 300)) { flags.paidSecretly = true; score += 2; ctx.fillStyle = COLORS.highlight; ctx.globalAlpha = 0.5; ctx.fillRect(500, 100, 200, 300); ctx.globalAlpha = 1.0; drawText('Â∑≤ÊÇÑÊÇÑ‰π∞Âçï', 600, 200, 20, COLORS.primary); mouse.clicked = false; return; }
      }
      ctx.fillStyle = '#fff8dc'; ctx.fillRect(0, 0, 800, 600);
      drawRect(200, 400, 400, 200, '#8b4513', 10);
      drawCircle(300, 420, 30, '#ddd'); drawCircle(500, 420, 30, '#ddd'); drawText('È•ÆÊñô', 300, 425, 12, '#aaa');
      drawBean(250, 350, false); drawBean(550, 350, true);
      ctx.fillStyle = '#d2b48c'; ctx.fillRect(550, 150, 150, 100); drawText('Êî∂Èì∂Âè∞', 625, 200, 16, '#fff');
      if (!flags.paidSecretly && !showDinnerOptions) { if (frameCount % 60 < 30) drawCircle(625, 140, 5, COLORS.primary); } else if (flags.paidSecretly) { drawText('‚úî', 625, 140, 20, 'green'); }
      drawRect(100, 50, 600, 100, '#fff', 10); ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(100, 50, 600, 100);
      billTimer++;
      let msg = '';
      if (billTimer < 200) msg = 'Â•πÔºö‰ªäÂ§©ÁÇπÂæóÁúü‰∏çÈîô ~ Âë≥ÈÅìÈÉΩ‰∏çËµñÔºÅ';
      else if (billTimer < 400) { msg = 'ÔºàÊúçÂä°ÂëòÂºÄÂßãÁªìË¥¶ÂçïÊÖ¢ÊÖ¢Ëµ∞Êù•‰∫å‰∫∫...Ôºâ'; let wX = 750 - (billTimer - 200); if (wX < 600) wX = 600; waiterX = wX; drawBean(wX, 300, false); drawRect(wX - 15, 320, 30, 40, '#fff', 2); }
      else { msg = 'ÊúçÂä°ÂëòÔºö‰Ω†‰ª¨ÔºåËØ∑ÈóÆËøôÁ¨îË¥¶ÂçïË¶ÅAAÂêóÔºü'; showDinnerOptions = true; }
      drawText(typeText(msg), 400, 100, 20, '#333');
      if (showDinnerOptions) {
        if (flags.paidSecretly) { drawRect(100, 50, 600, 100, '#fff', 10); drawText('ÊàëÔºöÊó¢ÁÑ∂‰ªéËÆ§ËØÜÁû¨Èó¥ÁöÑÊó∂ÂàªÂ∑≤ÁªèÁªèËøá‰∫Ü„ÄÇ', 400, 100, 20, '#333'); if (billTimer > 550) transitionTo(STATE.SCENE_3_WALK); }
        else { drawButton('ÊàëÊù•‰π∞Âçï', 200, 500, 150, 50, () => { score += 1; transitionTo(STATE.SCENE_3_WALK); }); drawButton('Êàë‰ª¨Ë¶ÅAAÂêóÔºü', 450, 500, 150, 50, () => { score -= 1; transitionTo(STATE.SCENE_3_WALK); }); }
      }
    }

    function updateScene3() {
      ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = 'rgba(255,255,255,0.5)'; for (let i = 0; i < 10; i++) { let x = (frameCount * 2 + i * 100) % 800; let y = (frameCount * 1 + i * 50) % 600; drawCircle(x, y, 2, '#fff'); }
      ctx.fillStyle = '#34495e'; ctx.fillRect(0, 450, 800, 150);
      const centerX = 400, charY = 400; let shake = 0; if (walkTimer > 100) shake = Math.sin(frameCount * 0.5) * 2;
      drawBean(centerX + 60 + shake, charY, true, 'normal'); ctx.fillStyle = '#ffcccc'; ctx.beginPath(); ctx.ellipse(centerX + 60 + shake, charY + 50, 20, 40, 0, 0, Math.PI * 2); ctx.fill();
      drawBean(centerX - 60, charY, false);
      let coatColor = '#8e44ad'; if (isHover(centerX - 80, charY + 10, 40, 80) && !flags.gaveCoat && walkTimer > 100) { coatColor = '#9b59b6'; canvas.style.cursor = 'pointer'; if (mouse.clicked) { flags.gaveCoat = true; mouse.clicked = false; score += 2; } }
      if (!flags.gaveCoat) { ctx.fillStyle = coatColor; ctx.beginPath(); ctx.ellipse(centerX - 60, charY + 50, 25, 45, 0, 0, Math.PI * 2); ctx.fill(); }
      else { ctx.fillStyle = '#bdc3c7'; ctx.beginPath(); ctx.ellipse(centerX - 60, charY + 50, 20, 40, 0, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = coatColor; ctx.beginPath(); ctx.ellipse(centerX + 60 + shake, charY + 55, 28, 48, 0, 0, Math.PI * 2); ctx.fill(); }
      drawRect(100, 50, 600, 100, '#fff', 10);
      walkTimer++;
      let msg = '';
      if (walkTimer < 100) msg = 'ÔºàËµ∞Âú®ÂõûÂÆ∂ÁöÑË∑Ø‰∏äÔºåÁÅØÂÖâÊò†ÁùÄ‰∫å‰∫∫Ë∫´ÂΩ±Êù•...Ôºâ';
      else if (walkTimer < 300) msg = 'Â•πÔºöÂóØ... ‰Ω†ÁúüÂ•Ω...';
      else if (!flags.gaveCoat) msg = 'ÊàëËØ•ÈóÆÈóÆ...';
      else msg = 'ÊàëÔºöÔºàËΩªËΩªËÑ±‰∏ãÂ§ñÂ•óÊä´Âú®Â•πË∫´‰∏äÔºâ';
      drawText(typeText(msg), 400, 100, 20, '#333');
      if (walkTimer >= 300 && !flags.gaveCoat) { drawButton('ÈóÆÂ•πÔºö‰Ω†ÂÜ∑ÂêóÔºü', 200, 500, 200, 50, () => { score -= 1; transitionTo(STATE.ENDING); }); drawButton('ÂùöÊåÅ‰∏ÄË∑ØËµ∞Âà∞ÂÆ∂', 450, 500, 200, 50, () => { score -= 2; transitionTo(STATE.ENDING); }); } else if (flags.gaveCoat && walkTimer > 450) transitionTo(STATE.ENDING);
    }

    function updateEnding() {
      ctx.fillStyle = COLORS.bg; ctx.fillRect(0, 0, 800, 600);
      drawText('ÊÅãÁà±ÁªìÊùü', 400, 150, 40, '#333');
      let title = '', desc = '', color = '';
      if (score >= 5) { title = 'ÂÆåÁæéÁªìÂ±ÄÔºöËøôÂ∞±ÊòØÁà±'; desc = 'Áà±‰∏çÊòØËØ¥ËØ¥ËÄåÂ∑≤ÔºåËÄåÊòØÊØè‰∏Ä‰∏™ÁªÜÂæÆÂ§ÑÁöÑ‰ΩìË¥¥‰∏éÂÆàÊä§„ÄÇ'; color = COLORS.primary; drawText('‚ù§ ‚ù§', 400, 350, 60, COLORS.primary); }
      else if (score >= 2) { title = 'ÊôÆÈÄöÁªìÂ±ÄÔºöÂ•Ω‰∫∫Âç°'; desc = '‰Ω†ÊòØ‰∏™Â•Ω‰∫∫Ôºå‰ΩÜÂèØËÉΩËøò‰∏çË∂≥‰ª•ÊÑüÂä®Â•π„ÄÇ'; color = '#f39c12'; drawText('üôÇ', 400, 350, 60, '#333'); }
      else { title = 'ÂùèÁªìÂ±ÄÔºöÁõ¥Áî∑Áôå'; desc = 'Êúâ‰∫õÊú∫‰ºö‰ºöÈîôËøáÔºåËøôÊâçÊòØÁúüÂÆûÁöÑÈîôËøá„ÄÇ'; color = '#7f8c8d'; drawText('üôÉ', 400, 350, 60, '#7f8c8d'); }
      drawText(title, 400, 250, 30, color);
      drawText(desc, 400, 300, 18, '#555');
      drawButton('ÈáçÊñ∞ÂºÄÂßã', 300, 450, 200, 50, () => { transitionTo(STATE.SCENE_1_CHAT, resetGame); });
    }

    function getMousePos(evt) { const rect = canvas.getBoundingClientRect(); return { x: (evt.clientX - rect.left) * (900 / rect.width), y: (evt.clientY - rect.top) * (600 / rect.height) }; }
    canvas.addEventListener('mousemove', (e) => { const pos = getMousePos(e); mouse.x = pos.x; mouse.y = pos.y; canvas.style.cursor = 'default'; });
    canvas.addEventListener('mousedown', () => { mouse.clicked = true; });
    canvas.addEventListener('touchstart', (e) => { const pos = getMousePos(e.touches[0]); mouse.x = pos.x; mouse.y = pos.y; mouse.clicked = true; e.preventDefault(); }, { passive: false });

    function loop() { frameCount++; ctx.clearRect(0, 0, 900, 600); switch (currentState) { case STATE.MENU: updateMenu(); break; case STATE.SCENE_1_CHAT: updateScene1(); break; case STATE.SCENE_1_PHONE: updateScene1Phone(); break; case STATE.SCENE_2_DINNER: updateScene2(); break; case STATE.SCENE_3_WALK: updateScene3(); break; case STATE.ENDING: updateEnding(); break; } if (currentState === STATE.SCENE_1_CHAT && !flags.sawMoments && frameCount < 300) { tooltip.style.opacity = 1; tooltip.innerText = 'ËØïËØïÁÇπÂºÄ‰∏ÄÊù°Á¨îËÆ∞Êù•‰∏çÊòØÊåâÈíÆÁöÑ‰∏úË•øÔºü'; } else { tooltip.style.opacity = 0; } if (mouse.clicked) mouse.clicked = false; requestAnimationFrame(loop); }
    resize();
    requestAnimationFrame(loop);
  </script>
  <script src="script.js"></script>
</body>
</html>
